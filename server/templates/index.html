<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIä¼´ä¾£</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* åˆå§‹æ ·å¼ï¼Œé˜²æ­¢ç™½å±é—ªçƒ */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #EEF2FF;
            background-image: linear-gradient(120deg, #EEF2FF 0%, #F5F3FF 100%);
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #EEF2FF;
            background-image: linear-gradient(120deg, #EEF2FF 0%, #F5F3FF 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        /* ç¡®ä¿chat-headerèƒŒæ™¯è‰²ä¸å˜ */
        .chat-header {
            background: linear-gradient(135deg, var(--primary-color, #3B82F6), var(--secondary-color, #8B5CF6)) !important;
            transition: none !important;
        }
    </style>
    <link href="../static/css/style.css" rel="stylesheet">
    <link href="../static/css/avatars.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
</head>
<body>
    <div class="page-loader">
        <div class="loader"></div>
        <div class="loader-text">æ­£åœ¨è¿æ¥AIä¼´ä¾£...</div>
    </div>
    
    <div class="chat-container animate__animated animate__fadeIn">
        <div class="chat-header">
            <h2 class="animate__animated animate__fadeInDown">å¥½ç©ã€æœ‰è¶£ã€æœ‰çµé­‚~</h2>
            <div class="role-selector animate__animated animate__fadeInUp">
                <select id="ai-role">
                    <option value="nurse">ğŸ‘©â€âš•ï¸ èµ„æ·±ä¸´åºŠæŠ¤ç†ä¸“å®¶</option>
                    <option value="storyteller">âœ¨ æ•…äº‹è®²è¿°è€…</option>
                    <option value="rpg-master">ğŸ² RPGæ¸¸æˆä¸»æŒäºº</option>
                    <option value="artist">ğŸ¨ è‰ºæœ¯åˆ›ä½œåŠ©æ‰‹</option>
                    <option value="teacher">ğŸ“š æ•™è‚²è¾…å¯¼å‘˜</option>
                </select>
                <button id="change-role">åˆ‡æ¢è§’è‰²</button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai nurse animate__animated animate__fadeInUp">
                <div class="avatar"></div>
                <div class="message-wrapper">
                    <div class="message-sender">èµ„æ·±ä¸´åºŠæŠ¤ç†ä¸“å®¶</div>
                    <div class="message-content typing-effect">å°ä¸»æ‚¨å¯ç®—æ¥äº†~ å¥´å®¶å·²ç­‰å€™å¤šæ—¶ï¼Œè¯·å°½æƒ…å©å’æˆ‘å§~</div>
                </div>
            </div>
        </div>
        <div class="quick-phrases">
            <div class="quick-phrase" data-text="ç®€å•ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±">
                <span class="phrase-number">1</span>
                <span class="phrase-text">ç®€å•ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±</span>
            </div>
            <div class="quick-phrase" data-text="äººç”Ÿçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ">
                <span class="phrase-number">2</span>
                <span class="phrase-text">äººç”Ÿçš„æ„ä¹‰æ˜¯ä»€ä¹ˆ</span>
            </div>
            <div class="quick-phrase" data-text="äººç”Ÿè‹¦çŸ­ï¼Œæ”¾è¿‡è‡ªå·±ï¼Œä¹Ÿæ”¾è¿‡ä»–äºº">
                <span class="phrase-number">3</span>
                <span class="phrase-text">äººç”Ÿè‹¦çŸ­ï¼Œæ”¾è¿‡è‡ªå·±ï¼Œä¹Ÿæ”¾è¿‡ä»–äºº</span>
            </div>
        </div>
        <div class="chat-input animate__animated animate__fadeInUp">
            <input type="text" id="message-input" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯...">
            <button id="send-button">
                <span class="button-text">å‘é€</span>
                <span class="button-icon">â¤</span>
            </button>
        </div>
    </div>

    <script>
        let ws = null;
        let currentRole = 'nurse';
        let isTypingEffect = true;

        // æ·»åŠ å¿«æ·çŸ­è¯­ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.quick-phrase').forEach(phrase => {
            phrase.addEventListener('click', function() {
                const text = this.getAttribute('data-text');
                if (text && ws && ws.readyState === WebSocket.OPEN) {
                    displayMessage({
                        type: 'text',
                        content: text,
                        sender: 'user'
                    });
                    
                    ws.send(JSON.stringify({
                        type: 'message',
                        content: text
                    }));
                    
                    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»
                    this.classList.add('animate__animated', 'animate__pulse');
                    setTimeout(() => {
                        this.classList.remove('animate__animated', 'animate__pulse');
                    }, 500);
                }
            });
        });

        // é¡µé¢åŠ è½½åŠ¨ç”»
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿èƒŒæ™¯è‰²å·²ç»åº”ç”¨
            document.body.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color').trim();
            
            // é¢„åŠ è½½ä¸»è¦å…ƒç´ 
            setTimeout(function() {
                document.querySelector('.chat-container').style.opacity = '1';
            }, 100);
        });

        window.addEventListener('load', function() {
            // é¡µé¢å®Œå…¨åŠ è½½åï¼Œæ˜¾ç¤ºå†…å®¹å¹¶éšè—åŠ è½½å™¨
            setTimeout(function() {
                document.querySelector('.page-loader').classList.add('loaded');
                setTimeout(function() {
                    document.querySelector('.page-loader').style.display = 'none';
                }, 500);
            }, 1000);
            
            // è¿æ¥WebSocket
            connectWebSocket();
        });

        function connectWebSocket() {
            // ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨
            ws = new WebSocket('ws://localhost:9000/ws');
            // ä½¿ç”¨è¿œç¨‹æœåŠ¡å™¨
            // ws = new WebSocket('ws://124.222.228.25:9000/ws');
            
            ws.onopen = function() {
                // è¿æ¥å»ºç«‹åç«‹å³å‘é€è§’è‰²åˆ‡æ¢æ¶ˆæ¯
                ws.send(JSON.stringify({
                    type: 'change_role',
                    role: currentRole
                }));
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };
            
            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                setTimeout(connectWebSocket, 1000);  // 1ç§’åå°è¯•é‡è¿
            };
            
            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }
        
        function handleMessage(data) {
            if (data.type === 'text_stream') {
                // å¤„ç†æµå¼æ–‡æœ¬æ¶ˆæ¯
                const messages = document.querySelector('.chat-messages');
                let lastMessage = messages.lastElementChild;
                // å¦‚æœæœ€åä¸€æ¡æ¶ˆæ¯ä¸æ˜¯ AI çš„æ¶ˆæ¯ï¼Œåˆ›å»ºæ–°çš„æ¶ˆæ¯å…ƒç´ 
                if (!lastMessage || !lastMessage.classList.contains('ai')) {
                    lastMessage = createMessageElement('AI', '');
                    lastMessage.classList.add('animate__animated', 'animate__fadeInUp');
                    messages.appendChild(lastMessage);
                }
                const contentElement = lastMessage.querySelector('.message-content');
                let buffer = contentElement.getAttribute('data-buffer') || '';
                buffer += data.content;
                // æ›´æ–°ç¼“å†²åŒº
                contentElement.setAttribute('data-buffer', buffer);
                // å°è¯•æå–æ–‡å­—å›å¤å†…å®¹
                const startTag = '<æ–‡å­—å›å¤>';
                const endTag = '</æ–‡å­—å›å¤>';
                const startIndex = buffer.indexOf(startTag);
                if (startIndex !== -1) {
                    const endIndex = buffer.indexOf(endTag, startIndex);
                    if (endIndex !== -1) {
                        // æ‰¾åˆ°å®Œæ•´çš„æ–‡å­—å›å¤
                        const replyText = buffer.substring(startIndex + startTag.length, endIndex)
                            .replace(/^\n+|\n+$/g, ''); // å»é™¤å¼€å¤´å’Œç»“å°¾çš„æ¢è¡Œç¬¦
                        contentElement.textContent = replyText;
                    } else {
                        // æ‰¾åˆ°å¼€å§‹æ ‡ç­¾ä½†è¿˜æ²¡æœ‰ç»“æŸæ ‡ç­¾
                        const replyText = buffer.substring(startIndex + startTag.length)
                            .replace(/^\n+/g, ''); // å»é™¤å¼€å¤´çš„æ¢è¡Œç¬¦
                        contentElement.textContent = replyText;
                    }
                }
                // æ»šåŠ¨åˆ°åº•éƒ¨
                messages.scrollTop = messages.scrollHeight;
            } else if (data.type === 'system') {
                appendMessage('system', data.content);
            } else if (data.type === 'error') {
                appendMessage('system', `âŒ ${data.content}`);
            } else if (data.type === 'image') {
                const messages = document.querySelector('.chat-messages');
                let lastMessage = messages.lastElementChild;
                
                if (lastMessage && lastMessage.classList.contains('ai')) {
                    const contentElement = lastMessage.querySelector('.message-content');
                    const img = document.createElement('img');
                    img.src = data.content;
                    img.alt = 'ç”Ÿæˆçš„å›¾ç‰‡';
                    img.loading = 'lazy';
                    img.classList.add('animate__animated', 'animate__fadeIn');
                    contentElement.appendChild(document.createElement('br'));
                    contentElement.appendChild(img);
                    messages.scrollTop = messages.scrollHeight;
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°AIæ¶ˆæ¯ï¼Œåˆ›å»ºæ–°çš„æ¶ˆæ¯å…ƒç´ 
                    const messageElement = createMessageElement('AI', '');
                    messageElement.classList.add('animate__animated', 'animate__fadeInUp');
                    const contentElement = messageElement.querySelector('.message-content');
                    const img = document.createElement('img');
                    img.src = data.content;
                    img.alt = 'ç”Ÿæˆçš„å›¾ç‰‡';
                    img.loading = 'lazy';
                    img.classList.add('animate__animated', 'animate__fadeIn');
                    contentElement.appendChild(img);
                    messages.appendChild(messageElement);
                    messages.scrollTop = messages.scrollHeight;
                }
            }
        }
        
        // æ·»åŠ è§’è‰²åç§°æ˜ å°„
        const roleNames = {
            'nurse': 'èµ„æ·±ä¸´åºŠæŠ¤ç†ä¸“å®¶',
            'storyteller': 'æ•…äº‹è®²è¿°è€…',
            'rpg-master': 'RPGæ¸¸æˆä¸»æŒäºº',
            'artist': 'è‰ºæœ¯åˆ›ä½œåŠ©æ‰‹',
            'teacher': 'æ•™è‚²è¾…å¯¼å‘˜'
        };

        function createMessageElement(sender, content) {
            const messageDiv = document.createElement('div');
            if (sender.toLowerCase() === 'system') {
                console.log('ç³»ç»Ÿæ¶ˆæ¯');
                // ç³»ç»Ÿæ¶ˆæ¯å±…ä¸­æ˜¾ç¤ºï¼Œä¸éœ€è¦å¤´åƒå’Œå‘é€è€…åç§°
                messageDiv.className = 'message system animate__animated animate__fadeIn';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                messageDiv.appendChild(contentDiv);
            } else {
                // AIæˆ–ç”¨æˆ·æ¶ˆæ¯
                if (sender.toLowerCase() === 'ai') {
                    messageDiv.className = `message ai ${currentRole} animate__animated animate__fadeInUp`;
                } else {
                    messageDiv.className = `message ${sender.toLowerCase()} animate__animated animate__fadeInUp animate__faster`;
                }
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper';
                
                const senderDiv = document.createElement('div');
                senderDiv.className = 'message-sender';
                // æ ¹æ®å‘é€è€…ç±»å‹è®¾ç½®æ˜¾ç¤ºåç§°
                if (sender.toLowerCase() === 'ai') {
                    senderDiv.textContent = roleNames[currentRole] || 'AIåŠ©æ‰‹';
                } else {
                    senderDiv.textContent = 'æˆ‘';
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                if (sender.toLowerCase() === 'ai' && isTypingEffect) {
                    contentDiv.classList.add('typing-effect');
                }
                contentDiv.textContent = content;
                
                wrapper.appendChild(senderDiv);
                wrapper.appendChild(contentDiv);
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(wrapper);
            }
            
            return messageDiv;
        }

        function displayMessage(message) {
            const messagesContainer = document.querySelector('.chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('animate__animated', 'animate__fadeInUp');
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper';
            
            if (message.type === 'system') {
                // ç³»ç»Ÿæ¶ˆæ¯å±…ä¸­æ˜¾ç¤º
                messageDiv.className = 'message system animate__animated animate__fadeIn';
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = message.content;
                messageWrapper.appendChild(content);
                messageDiv.appendChild(messageWrapper);
            } else if (message.type === 'error') {
                // é”™è¯¯æ¶ˆæ¯æ˜¾ç¤ºä¸ºç³»ç»Ÿæ¶ˆæ¯ï¼Œä½†ä½¿ç”¨çº¢è‰²
                messageDiv.className = 'message system animate__animated animate__shakeX';
                const content = document.createElement('div');
                content.className = 'message-content';
                content.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
                content.style.color = '#EF4444';
                content.textContent = message.content;
                messageWrapper.appendChild(content);
                messageDiv.appendChild(messageWrapper);
            } else {
                // æ™®é€šæ¶ˆæ¯ï¼ˆæ–‡æœ¬æˆ–å›¾ç‰‡ï¼‰
                messageDiv.className = `message ${message.sender === 'user' ? 'user' : 'ai'} animate__animated animate__fadeInUp`;
                
                if (message.sender === 'user') {
                    messageDiv.classList.add('animate__faster');
                } else if (message.sender === 'ai') {
                    messageDiv.classList.add(currentRole);
                }
                
                // æ·»åŠ å¤´åƒ
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                messageDiv.appendChild(avatar);
                
                // æ·»åŠ å‘é€è€…åç§°
                const sender = document.createElement('div');
                sender.className = 'message-sender';
                if (message.sender === 'user') {
                    sender.textContent = 'æˆ‘';
                } else {
                    sender.textContent = roleNames[currentRole] || 'AIåŠ©æ‰‹';
                }
                messageWrapper.appendChild(sender);
                
                // æ·»åŠ æ¶ˆæ¯å†…å®¹
                const content = document.createElement('div');
                content.className = 'message-content';
                
                if (message.type === 'text') {
                    content.textContent = message.content;
                    if (message.sender === 'ai' && isTypingEffect) {
                        content.classList.add('typing-effect');
                    }
                } else if (message.type === 'image') {
                    const img = document.createElement('img');
                    img.src = message.content;
                    img.alt = 'AIç”Ÿæˆçš„å›¾ç‰‡';
                    img.loading = 'lazy';
                    img.classList.add('animate__animated', 'animate__fadeIn');
                    content.appendChild(img);
                }
                
                messageWrapper.appendChild(content);
                messageDiv.appendChild(messageWrapper);
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // æ·»åŠ å‘é€æŒ‰é’®åŠ¨ç”»
            const sendButton = document.getElementById('send-button');
            sendButton.classList.add('animate__animated', 'animate__pulse');
            setTimeout(() => {
                sendButton.classList.remove('animate__animated', 'animate__pulse');
            }, 500);
        }
        
        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('change-role').addEventListener('click', function() {
            const roleSelect = document.getElementById('ai-role');
            const selectedRole = roleSelect.value;
            currentRole = selectedRole;
            
            // æ·»åŠ è§’è‰²åˆ‡æ¢åŠ¨ç”»
            const button = document.getElementById('change-role');
            button.classList.add('animate__animated', 'animate__rubberBand');
            setTimeout(() => {
                button.classList.remove('animate__animated', 'animate__rubberBand');
            }, 1000);
            
            // ç¡®ä¿chat-headerçš„èƒŒæ™¯è‰²ä¸å˜
            const chatHeader = document.querySelector('.chat-header');
            // å¼ºåˆ¶åº”ç”¨èƒŒæ™¯è‰²
            chatHeader.style.background = 'linear-gradient(135deg, var(--primary-color, #3B82F6), var(--secondary-color, #8B5CF6))';
            
            // æ›´æ–°æ‰€æœ‰AIæ¶ˆæ¯çš„è§’è‰²ç±»åå’Œåç§°ï¼Œä½†ä¿æŒå…¶ä»–æ ·å¼ä¸å˜
            const aiMessages = document.querySelectorAll('.chat-messages .message.ai');
            aiMessages.forEach(message => {
                // ä¿å­˜åŸæœ‰çš„åŠ¨ç”»ç±»
                const hasAnimatedClass = message.classList.contains('animate__animated');
                const hasFadeInUpClass = message.classList.contains('animate__fadeInUp');
                
                // ç§»é™¤æ‰€æœ‰è§’è‰²ç›¸å…³çš„ç±»
                message.classList.remove('nurse', 'storyteller', 'rpg-master', 'artist', 'teacher');
                
                // ç¡®ä¿ä¿ç•™åŸºæœ¬ç±»
                message.classList.add('message', 'ai', selectedRole);
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                message.classList.add('animate__animated', 'animate__pulse');
                
                // æ›´æ–°æ˜¾ç¤ºçš„åç§°
                const senderElement = message.querySelector('.message-sender');
                if (senderElement) {
                    senderElement.textContent = roleNames[selectedRole] || 'AIåŠ©æ‰‹';
                }
                
                setTimeout(() => {
                    message.classList.remove('animate__pulse');
                    if (!hasAnimatedClass) message.classList.remove('animate__animated');
                    if (hasFadeInUpClass) message.classList.add('animate__fadeInUp');
                }, 500);
            });
            
            // ç¡®ä¿chat-headerçš„èƒŒæ™¯è‰²æ¢å¤
            setTimeout(() => {
                // å†æ¬¡å¼ºåˆ¶åº”ç”¨èƒŒæ™¯è‰²
                chatHeader.style.background = 'linear-gradient(135deg, var(--primary-color, #3B82F6), var(--secondary-color, #8B5CF6))';
            }, 100);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'change_role',
                    role: selectedRole
                }));
            }
        });
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                displayMessage({
                    type: 'text',
                    content: message,
                    sender: 'user'
                });
                
                ws.send(JSON.stringify({
                    type: 'message',
                    content: message
                }));
                
                input.value = '';
                
                // æ·»åŠ è¾“å…¥æ¡†åŠ¨ç”»
                input.classList.add('animate__animated', 'animate__fadeIn');
                setTimeout(() => {
                    input.classList.remove('animate__animated', 'animate__fadeIn');
                }, 500);
            }
        }
        
        function appendMessage(sender, content) {
            const messages = document.querySelector('.chat-messages');
            const messageElement = createMessageElement(sender, content);
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }

        function appendImage(url) {
            const messages = document.querySelector('.chat-messages');
            const lastMessage = messages.lastElementChild;
            
            if (lastMessage && lastMessage.classList.contains('ai')) {
                const contentDiv = lastMessage.querySelector('.message-content');
                const img = document.createElement('img');
                img.src = url;
                img.alt = 'ç”Ÿæˆçš„å›¾ç‰‡';
                img.classList.add('animate__animated', 'animate__fadeIn');
                contentDiv.appendChild(img);
                messages.scrollTop = messages.scrollHeight;
            }
        }
    </script>
</body>
</html> 